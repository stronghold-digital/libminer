use serde::Deserialize;
use crate::{
    error::Error,
    miners::common::{StatsResp, StatusCode, AvaStats, Stats}
};
use super::{
    asc::PowerSupplyInfo,
    de,
};

#[derive(Deserialize, Debug)]
pub struct Status {
    #[serde(rename = "STATUS")]
    pub status: StatusCode,
    // Whatsminer doesn't always return When or Code
    #[serde(rename = "When")]
    pub when: Option<usize>,
    #[serde(rename = "Code")]
    pub code: Option<usize>,
    #[serde(rename = "Msg")]
    pub msg: String,
    #[serde(rename = "Description")]
    pub description: Option<String>,
}

#[derive(Deserialize, Debug)]
pub struct SysStatus {
    /// Whether the mining is hashing (== "In Work")
    #[serde(rename = "Work")]
    pub work: String,
    /// Number of hashboards
    #[serde(rename = "Hash Board")]
    pub nboards: u8,
}

#[derive(Deserialize, Debug)]
#[serde(rename_all = "PascalCase")]
pub struct RCD {
    pub tenv: i32,
    pub tavg: i32,
    pub fan1: i32,
    pub fan2: i32,
    // This is passed as a unsigned int, but our deserializer should convert to a float
    pub v12: f32,
    pub vout: f32,
    #[serde(rename = "P_I")]
    pub pi: i32,
    #[serde(rename = "P_O")]
    pub po: i32,
}

#[derive(Deserialize, Debug)]
#[serde(rename_all = "UPPERCASE")]
pub struct EStats {
    /// Version marker for the firmware??
    #[serde(rename = "Ver")]
    pub ver: String,
    pub dna: String,
    pub netfail: Vec<i32>,
    #[serde(rename = "SYSTEMSTATU")]
    pub sys_status: SysStatus,
    /// Uptime
    #[serde(rename = "Elapsed")]
    pub elapsed: u64,
    /// Miner's aggregate temperature
    #[serde(rename = "Temp")]
    pub temp: i32,
    /// Max temperature seen by the miner
    #[serde(rename = "TMax")]
    pub tmax: i32,
    /// Average temperature seen by the miner
    #[serde(rename = "TAvg")]
    pub tavg: i32,
    /// Fan1 speed
    #[serde(rename = "Fan1")]
    pub fan1: u32,
    /// Fan2 speed
    #[serde(rename = "Fan2")]
    pub fan2: u32,
    /// Fan3 speed
    #[serde(rename = "Fan3")]
    pub fan3: u32,
    /// Fan4 speed
    #[serde(rename = "Fan4")]
    pub fan4: u32,
    /// Fan PMW signal
    #[serde(rename = "FanR")]
    pub fanr: f64,
    /// Power supply information
    pub ps: PowerSupplyInfo,
    /// Real time hashrate
    #[serde(rename = "GHSmm")]
    pub ghs_mm: f64,
    /// Average hashrate
    #[serde(rename = "GHSavg")]
    pub ghs_av: f64,
    /// Current frequency of the hashboards
    #[serde(rename = "Freq")]
    pub freq: f64,
    /// Led status (0 == off, 1 == on)
    #[serde(rename = "Led")]
    pub led: u8,
    /// Per hashboard hashrate
    pub mghs: Vec<f64>,
    /// Per hashboard max temperature
    #[serde(rename = "MTmax")]
    pub mtmax: Vec<i32>,
    /// Per hashboard average temperature
    #[serde(rename = "MTavg")]
    pub mtavg: Vec<i32>,
    pub workmode: u8,
}

impl TryFrom<&AvaStats> for EStats {
    type Error = Error;

    fn try_from(stats: &AvaStats) -> Result<Self, Self::Error> {
        match de::from_str(&stats.mm_id0) {
            Ok(stats) => Ok(stats),
            Err(e) => {
                println!("String: {}", stats.mm_id0);
                println!("Error: {}", e);
                Err(e.into())
            },
        }
    }
}

impl TryFrom<&StatsResp> for EStats {
    type Error = Error;

    fn try_from(resp: &StatsResp) -> Result<Self, Self::Error> {
        if resp.status[0].status == StatusCode::ERROR {
            return Err(Error::InvalidResponse);
        }
        if let Some(stats) = &resp.stats {
            if let Some(ref stats) = stats.get(0) {
                match stats {
                    Stats::AvaStats(ref stats) => Self::try_from(stats),
                    _ => Err(Error::InvalidResponse),
                }
            } else {
                Err(Error::InvalidResponse)
            }
        } else {
            Err(Error::InvalidResponse)
        }
    }
}

#[cfg(test)]
mod tests {
    use super::*;

    #[test]
    fn test_str() {
        let s = r#"Ver[1246-81-21030201_4ec6bb0_09b1765] DNA[020100000828a153] MEMFREE[1358896.0] NETFAIL[0 0 0 0 0 0 0 0] SYSTEMSTATU[Work: In Work, Hash Board: 3 ] Elapsed[1750] BOOTBY[0x0A.00000002] LW[1730255] MH[80 93 67] HW[240] DH[6.553%] Temp[23] TMax[88] TAvg[66] Fan1[3337] Fan2[3302] Fan3[3302] Fan4[3288] FanR[54%] Vo[310] PS[0 1197 1240 261 3239 1240] PLL0[8235 2234 1835 1616] PLL1[9161 2800 1641 318] PLL2[7297 2653 2197 1773] GHSspd[80521.10] DHspd[6.553%] GHSmm[86564.08] GHSavg[75781.50] WU[1058655.28] Freq[518.22] Led[0] MGHS[25280.59 24670.18 25830.72] MTmax[88 86 81] MTavg[68 62 67] TA[360] Core[A3201] PING[42] POWS[0] HASHS[0 0 0] POOLS[0] SoftOFF[0] ECHU[0 0 0] ECMM[0] SF0[504 524 544 564] SF1[504 524 544 564] SF2[504 524 544 564] PVT_T0[ 79  77  74  72  77  74  71  73  74  76  77  73  71  75  76  76  74  71  71  77  81  83  76  73  70  73  75  78  75  68  66  74  79  86  71  68  68  71  88  87  69  68  65  66  85  82  66  63  62  64  75  68  65  62  60  62  63  64  64  59  57  59  58  59  59  60  60  58  59  63  62  62  61  59  64  71  68  63  64  68  68  65  62  67  67  61  71  63  64  64  64  66  62  70  64  66  67  70  63  74  69  67  66  71  71  69  67  71  69  69  69  64  69  68  71  69  64  71  73  71] PVT_T1[ 61  62  71  69  65  61  62  62  67  66  65  60  62  66  70  68  64  64  68  66  64  70  69  65  64  68  70  67  86  62  64  66  67  65  68  65  66  67  66  65  65  67  64  69  66  64  67  63  63  64  63  63  61  59  58  61  63  63  59  56  57  54  54  52  55  57  57  55  57  59  56  58  57  62  60  68  61  62  59  63  67  61  60  64  60  59  57  59  58  64  64  56  56  60  59  62  64  60  62  61  61  61  58  59  58  56  59  58  59  59  63  59  60  59  60  62  59  58  62  62] PVT_T2[ 68  73  74  77  70  67  69  67  72  76  69  67  68  70  81  80  70  69  70  71  76  76  69  67  66  68  76  73  69  63  66  68  79  74  69  64  67  71  76  74  70  67  68  69  76  77  65  65  62  66  69  69  65  62  63  61  69  68  61  62  58  57  57  56  59  60  60  61  64  64  60  63  62  65  67  71  72  64  60  69  68  71  63  63  64  66  68  64  62  62  61  65  61  67  69  67  63  69  69  69  71  65  66  69  68  68  70  65  62  65  64  67  65  64  67  68  67  67  67  69] PVT_V0[281 287 290 285 286 286 286 285 287 282 279 277 275 274 274 277 281 282 278 278 275 275 279 283 283 282 282 285 282 283 287 290 292 278 283 286 282 283 288 282 285 286 281 283 278 283 289 287 293 291 291 290 291 293 290 298 294 290 287 292 291 292 290 287 290 297 285 291 295 295 298 294 281 283 285 274 275 283 288 288 292 290 297 297 282 289 290 290 293 293 271 275 278 273 274 283 289 289 294 289 289 287 288 286 285 292 293 292 289 290 292 271 281 283 270 278 285 277 282 288] PVT_V1[286 294 293 287 294 295 283 286 291 290 291 289 279 281 283 276 286 286 282 283 284 291 290 287 286 288 285 283 292 284 285 289 289 278 281 285 281 282 285 280 286 283 279 280 281 287 285 286 292 288 291 281 283 285 283 283 285 285 289 294 284 283 283 286 287 291 292 294 295 296 297 297 292 291 294 288 289 290 289 285 286 291 291 287 291 291 291 292 294 293 289 290 292 290 289 288 277 281 280 283 282 283 288 290 291 295 294 294 289 291 289 289 292 290 286 288 290 283 289 289] PVT_V2[291 293 297 286 281 275 285 282 277 281 283 286 278 279 281 286 289 289 286 287 281 279 274 273 273 277 278 275 283 282 279 279 271 288 281 279 276 274 268 287 281 278 292 292 289 276 280 286 275 277 278 282 283 286 283 287 284 278 282 286 301 296 293 283 284 286 291 294 294 293 293 291 297 290 295 293 294 294 282 283 292 281 290 286 302 297 297 294 294 294 292 290 290 293 292 287 277 278 282 271 275 276 277 275 283 291 292 291 291 293 297 288 289 288 291 290 283 292 289 290] MW[581853 581903 581986] MW0[72 92 84 86 108 102 73 98 86 89 78 91 54 76 91 83 77 67 82 68 83 90 82 75 72 77 73 87 77 70 88 91 82 85 81 86 61 69 89 86 77 68 61 84 76 104 98 66 80 89 82 107 95 83 84 67 90 73 89 90 101 84 92 97 97 88 86 90 71 107 96 92 70 76 84 89 83 55 86 104 94 82 86 88 83 70 84 98 95 103 69 88 90 81 82 60 82 86 83 89 76 95 81 95 96 93 75 101 96 78 85 88 58 89 76 93 81 64 98 84] MW1[70 75 89 87 75 93 90 66 105 75 80 99 98 65 72 91 43 91 93 62 84 86 86 84 93 76 85 39 106 87 74 95 76 78 82 78 84 84 72 88 78 83 59 52 78 95 84 58 49 94 91 105 87 87 75 80 81 93 76 87 100 79 57 88 106 92 95 64 85 77 73 87 79 83 87 103 55 90 55 90 105 87 53 95 101 80 80 79 71 94 104 71 64 72 76 103 71 87 72 81 97 83 68 98 101 108 84 86 89 84 78 71 77 52 86 87 85 68 95 87] MW2[88 107 95 78 101 85 66 100 87 85 77 82 70 68 83 104 86 73 86 100 103 80 74 88 83 89 84 92 78 79 70 71 72 91 76 75 68 65 71 77 110 88 94 82 75 66 85 66 75 67 94 104 76 85 100 61 98 97 89 89 85 84 85 72 79 93 97 70 87 87 73 105 93 110 83 85 103 87 97 87 76 105 67 83 101 95 93 100 97 85 88 94 89 87 86 95 95 100 88 54 88 82 79 90 79 95 98 77 100 85 90 82 92 83 90 75 82 98 68 106] ASICCRC0[0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0] ASICCRC1[0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0] ASICCRC2[0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0] CRC[0 0 0] POW_I2C[OK] FACOPTS0[] FACOPTS1[] ATAOPTS0[--avalon10-freq 504:524:544:564 --avalon10-voltage-level 39 ] ATAOPTS1[--avalon10-freq 504:524:544:564 --avalon10-voltage-level 35 ] ADJ[1] COP[0 0 0] MPO[3200] MVL[87] ATABD0[504 524 544 564] ATABD1[504 524 544 564] ATABD2[504 524 544 564] WORKMODE[1]"#;
        let _: EStats = de::from_str(s).unwrap();
    }

    #[test]
    fn test_resp() {
        let resp = r#"{"STATUS":[{"STATUS":"S","When":1849,"Code":70,"Msg":"CGMiner stats","Description":"cgminer 4.11.1"}],"STATS":[{"STATS":0,"ID":"AVA100","Elapsed":1750,"Calls":0,"Wait":0.000000,"Max":0.000000,"Min":99999999.000000,"MM ID0":"Ver[1246-81-21030201_4ec6bb0_09b1765] DNA[020100000828a153] MEMFREE[1358896.0] NETFAIL[0 0 0 0 0 0 0 0] SYSTEMSTATU[Work: In Work, Hash Board: 3 ] Elapsed[1750] BOOTBY[0x0A.00000002] LW[1730255] MH[80 93 67] HW[240] DH[6.553%] Temp[23] TMax[88] TAvg[66] Fan1[3337] Fan2[3302] Fan3[3302] Fan4[3288] FanR[54%] Vo[310] PS[0 1197 1240 261 3239 1240] PLL0[8235 2234 1835 1616] PLL1[9161 2800 1641 318] PLL2[7297 2653 2197 1773] GHSspd[80521.10] DHspd[6.553%] GHSmm[86564.08] GHSavg[75781.50] WU[1058655.28] Freq[518.22] Led[0] MGHS[25280.59 24670.18 25830.72] MTmax[88 86 81] MTavg[68 62 67] TA[360] Core[A3201] PING[42] POWS[0] HASHS[0 0 0] POOLS[0] SoftOFF[0] ECHU[0 0 0] ECMM[0] SF0[504 524 544 564] SF1[504 524 544 564] SF2[504 524 544 564] PVT_T0[ 79  77  74  72  77  74  71  73  74  76  77  73  71  75  76  76  74  71  71  77  81  83  76  73  70  73  75  78  75  68  66  74  79  86  71  68  68  71  88  87  69  68  65  66  85  82  66  63  62  64  75  68  65  62  60  62  63  64  64  59  57  59  58  59  59  60  60  58  59  63  62  62  61  59  64  71  68  63  64  68  68  65  62  67  67  61  71  63  64  64  64  66  62  70  64  66  67  70  63  74  69  67  66  71  71  69  67  71  69  69  69  64  69  68  71  69  64  71  73  71] PVT_T1[ 61  62  71  69  65  61  62  62  67  66  65  60  62  66  70  68  64  64  68  66  64  70  69  65  64  68  70  67  86  62  64  66  67  65  68  65  66  67  66  65  65  67  64  69  66  64  67  63  63  64  63  63  61  59  58  61  63  63  59  56  57  54  54  52  55  57  57  55  57  59  56  58  57  62  60  68  61  62  59  63  67  61  60  64  60  59  57  59  58  64  64  56  56  60  59  62  64  60  62  61  61  61  58  59  58  56  59  58  59  59  63  59  60  59  60  62  59  58  62  62] PVT_T2[ 68  73  74  77  70  67  69  67  72  76  69  67  68  70  81  80  70  69  70  71  76  76  69  67  66  68  76  73  69  63  66  68  79  74  69  64  67  71  76  74  70  67  68  69  76  77  65  65  62  66  69  69  65  62  63  61  69  68  61  62  58  57  57  56  59  60  60  61  64  64  60  63  62  65  67  71  72  64  60  69  68  71  63  63  64  66  68  64  62  62  61  65  61  67  69  67  63  69  69  69  71  65  66  69  68  68  70  65  62  65  64  67  65  64  67  68  67  67  67  69] PVT_V0[281 287 290 285 286 286 286 285 287 282 279 277 275 274 274 277 281 282 278 278 275 275 279 283 283 282 282 285 282 283 287 290 292 278 283 286 282 283 288 282 285 286 281 283 278 283 289 287 293 291 291 290 291 293 290 298 294 290 287 292 291 292 290 287 290 297 285 291 295 295 298 294 281 283 285 274 275 283 288 288 292 290 297 297 282 289 290 290 293 293 271 275 278 273 274 283 289 289 294 289 289 287 288 286 285 292 293 292 289 290 292 271 281 283 270 278 285 277 282 288] PVT_V1[286 294 293 287 294 295 283 286 291 290 291 289 279 281 283 276 286 286 282 283 284 291 290 287 286 288 285 283 292 284 285 289 289 278 281 285 281 282 285 280 286 283 279 280 281 287 285 286 292 288 291 281 283 285 283 283 285 285 289 294 284 283 283 286 287 291 292 294 295 296 297 297 292 291 294 288 289 290 289 285 286 291 291 287 291 291 291 292 294 293 289 290 292 290 289 288 277 281 280 283 282 283 288 290 291 295 294 294 289 291 289 289 292 290 286 288 290 283 289 289] PVT_V2[291 293 297 286 281 275 285 282 277 281 283 286 278 279 281 286 289 289 286 287 281 279 274 273 273 277 278 275 283 282 279 279 271 288 281 279 276 274 268 287 281 278 292 292 289 276 280 286 275 277 278 282 283 286 283 287 284 278 282 286 301 296 293 283 284 286 291 294 294 293 293 291 297 290 295 293 294 294 282 283 292 281 290 286 302 297 297 294 294 294 292 290 290 293 292 287 277 278 282 271 275 276 277 275 283 291 292 291 291 293 297 288 289 288 291 290 283 292 289 290] MW[581853 581903 581986] MW0[72 92 84 86 108 102 73 98 86 89 78 91 54 76 91 83 77 67 82 68 83 90 82 75 72 77 73 87 77 70 88 91 82 85 81 86 61 69 89 86 77 68 61 84 76 104 98 66 80 89 82 107 95 83 84 67 90 73 89 90 101 84 92 97 97 88 86 90 71 107 96 92 70 76 84 89 83 55 86 104 94 82 86 88 83 70 84 98 95 103 69 88 90 81 82 60 82 86 83 89 76 95 81 95 96 93 75 101 96 78 85 88 58 89 76 93 81 64 98 84] MW1[70 75 89 87 75 93 90 66 105 75 80 99 98 65 72 91 43 91 93 62 84 86 86 84 93 76 85 39 106 87 74 95 76 78 82 78 84 84 72 88 78 83 59 52 78 95 84 58 49 94 91 105 87 87 75 80 81 93 76 87 100 79 57 88 106 92 95 64 85 77 73 87 79 83 87 103 55 90 55 90 105 87 53 95 101 80 80 79 71 94 104 71 64 72 76 103 71 87 72 81 97 83 68 98 101 108 84 86 89 84 78 71 77 52 86 87 85 68 95 87] MW2[88 107 95 78 101 85 66 100 87 85 77 82 70 68 83 104 86 73 86 100 103 80 74 88 83 89 84 92 78 79 70 71 72 91 76 75 68 65 71 77 110 88 94 82 75 66 85 66 75 67 94 104 76 85 100 61 98 97 89 89 85 84 85 72 79 93 97 70 87 87 73 105 93 110 83 85 103 87 97 87 76 105 67 83 101 95 93 100 97 85 88 94 89 87 86 95 95 100 88 54 88 82 79 90 79 95 98 77 100 85 90 82 92 83 90 75 82 98 68 106] ASICCRC0[0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0] ASICCRC1[0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0] ASICCRC2[0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0] CRC[0 0 0] POW_I2C[OK] FACOPTS0[] FACOPTS1[] ATAOPTS0[--avalon10-freq 504:524:544:564 --avalon10-voltage-level 39 ] ATAOPTS1[--avalon10-freq 504:524:544:564 --avalon10-voltage-level 35 ] ADJ[1] COP[0 0 0] MPO[3200] MVL[87] ATABD0[504 524 544 564] ATABD1[504 524 544 564] ATABD2[504 524 544 564] WORKMODE[1]","MM Count":1,"Smart Speed":1,"Voltage Level Offset":0,"Nonce Mask":25}],"id":1}"#;
        let stats: StatsResp = serde_json::from_str(resp).unwrap();
        let _ = EStats::try_from(&stats).unwrap();
    }

    #[test]
    fn test_str2() {
        let s = r#"Ver[1246-81-21072802_4ec6bb0_211fc46] DNA[02010000c039a5f3] MEMFREE[1215304.0] NETFAIL[0 0 0 0 0 0 0 0] SYSTEMSTATU[Work: In Work, Hash Board: 3 ] Elapsed[3527] BOOTBY[0x05.00000000] LW[3197240] MH[2370 9 4] HW[2383] DH[12.025%] Temp[42] TMax[83] TAvg[66] Fan1[6741] Fan2[6680] Fan3[6759] Fan4[6759] FanR[100%] Vo[312] PS[0 1201 1251 256 3202 1252 3603] PLL0[9907 1608 3393 59] PLL1[4411 1283 2045 6181] PLL2[4588 1924 2827 4581] GHSspd[75224.46] DHspd[4.971%] GHSmm[59755.28] GHSavg[69243.04] WU[967314.16] Freq[357.73] Led[0] MGHS[14169.30 27597.97 27475.78] MTmax[83 74 73] MTavg[69 66 65] TA[360] Core[A3201] PING[40] POWS[0] HASHS[0 0 0] POOLS[0] SoftOFF[0] ECHU[0 0 0] ECMM[0] SF0[488 508 528 548] SF1[488 508 528 548] SF2[488 508 528 548] PVT_T0[ 74  75  83  77  76  76  74  76  76  76  74  74  76  75  77  78  78  75  73  74  74  72  69  69  69  70  71  69  72  68  70  69  69  74  72  66  67  67  68  69  67  64  66  67  65  65  66  65  63  62  63  62  62  62  62  61  67  63  61  61  62  59  61  64  63  61  61  62  71  64  64  63  64  67  64  65  67  65  64  63  64  67  65  65  65  66  66  67  69  69  66  74  69  73  78  69  67  73  68  79  77  76  71  76  74  73  73  72  71  71  68  71  70  72  80  76  71  73  76  77] PVT_T1[ 66  71  70  70  69  66  66  69  67  66  67  67  67  66  65  69  69  69  69  70  70  69  69  69  64  70  72  72  69  66  69  67  74  71  68  67  64  68  70  69  67  64  67  66  68  65  70  65  64  64  65  64  68  69  67  64  64  63  61  64  62  61  62  64  64  63  63  64  62  64  63  65  62  62  63  64  64  65  63  63  66  67  67  64  69  65  64  67  65  68  64  67  68  67  67  65  66  64  65  66  67  69  65  63  66  64  64  64  67  63  67  65  63  65  66  65  67  65  65  65] PVT_T2[ 67  70  68  73  68  70  69  69  70  69  70  71  70  70  72  71  71  66  66  69  68  68  67  66  65  65  66  69  68  65  63  67  69  68  66  66  64  66  70  67  64  66  64  65  69  69  65  63  62  65  67  64  64  68  61  62  64  62  64  63  59  63  62  64  63  61  62  63  64  65  60  64  63  66  65  66  64  61  63  61  63  60  62  63  64  63  62  63  64  64  64  65  63  64  64  69  62  64  63  64  66  68  66  67  66  64  64  68  67  66  66  66  66  66  66  69  66  64  72  70] PVT_V0[264 272 274 266 266 266 264 265 264 267 266 266 264 271 268 270 274 273 261 257 258 279 276 271 270 266 265 266 269 269 274 278 277 278 283 279 278 278 282 275 278 274 275 275 279 273 275 278 279 281 282 285 283 283 283 283 278 279 280 286 283 281 276 284 283 283 278 279 285 285 284 289 285 289 290 276 278 285 279 286 286 273 276 280 278 281 282 281 283 285 268 272 272 275 278 279 270 266 269 259 266 264 259 264 266 266 271 273 287 285 291 286 288 286 280 280 283 286 293 298] PVT_V1[284 287 291 285 286 286 285 287 288 287 291 292 292 295 290 295 292 297 286 292 294 284 287 283 292 290 286 289 291 294 287 295 294 286 287 286 282 284 280 283 283 280 292 289 291 285 289 286 293 291 295 283 293 287 296 297 302 287 291 297 305 297 302 290 292 297 299 301 304 292 292 292 299 302 299 284 282 286 284 287 286 289 291 294 286 286 287 286 287 286 283 285 283 290 287 287 291 290 287 291 295 296 287 289 287 282 287 287 284 285 289 297 296 294 292 288 285 286 284 287] PVT_V2[285 287 291 292 287 291 286 284 289 294 297 294 288 283 283 290 286 286 289 285 285 293 295 294 286 284 282 295 294 292 292 286 294 289 292 290 288 285 286 287 285 283 292 290 291 294 293 295 292 289 292 301 294 297 297 297 294 293 299 304 301 298 297 294 290 292 293 299 294 293 294 293 294 290 292 292 290 298 289 291 297 288 284 285 295 295 292 292 292 297 286 291 293 291 291 286 285 282 281 291 292 292 285 290 289 279 280 284 292 292 295 291 292 287 290 291 286 280 281 279] MW[1065931 1065959 1066041] MW0[27 3 60 65 49 52 56 63 24 3 41 62 44 35 61 62 60 30 44 62 38 69 78 54 58 49 79 65 56 55 58 71 23 4 42 60 51 70 53 52 64 59 60 75 73 64 71 64 65 71 53 63 74 65 71 79 74 64 72 70 78 60 66 58 17 5 52 85 64 67 60 61 57 29 51 54 36 27 51 73 22 2 46 68 67 61 72 67 66 65 33 5 21 62 73 54 32 51 79 30 47 38 42 43 22 27 46 53 0 0 0 0 0 0 0 0 0 0 0 0] MW1[85 98 82 87 91 92 97 85 83 95 100 85 93 96 97 96 109 101 112 103 82 82 87 87 85 89 91 93 86 96 99 115 88 86 73 110 81 92 84 92 89 93 98 85 98 72 102 91 80 92 84 76 96 92 90 110 83 86 119 91 108 99 78 84 98 93 82 81 109 101 96 87 101 81 95 111 79 93 111 113 93 95 86 87 94 90 84 88 70 118 99 102 68 84 95 101 94 94 104 96 91 104 92 108 99 77 92 83 92 87 82 88 93 99 88 86 96 88 75 94] MW2[87 99 114 105 96 77 74 98 73 96 111 93 98 88 82 88 87 91 89 86 75 80 83 97 79 86 91 84 80 93 106 90 104 86 112 86 83 97 101 83 110 77 89 80 110 95 99 91 106 114 85 89 82 111 94 93 87 90 89 100 86 89 97 86 102 101 93 86 82 89 102 92 112 79 99 101 109 81 85 114 84 103 87 81 102 108 85 81 81 99 92 82 84 98 82 74 99 92 84 97 89 89 89 88 99 73 100 100 88 95 90 94 101 104 81 83 104 81 86 87] ASICCRC0[977 1 0 0 3 0 1 0 95 0 0 0 2 0 0 0 0 0 0 0 0 0 0 0 1 0 0 0 0 0 0 0 8 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 1 0 0 1 0 0 0 0 0 1 0 1 2 0 0 0 1 0 0 0 2 0 0 0 1 0 0 0 1 0 0 0 0 0 0 0 0 0 1 1 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0] ASICCRC1[0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0] ASICCRC2[0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0] CRC[4167710094 0 0] POW_I2C[OK] FACOPTS0[] FACOPTS1[] ATAOPTS0[--avalon10-freq 480:500:520:540 --avalon10-voltage-level 36 ] ATAOPTS1[--avalon10-freq 488:508:528:548 --avalon10-voltage-level 37 ] ADJ[1] COP[0 0 0] MPO[3200] MVL[87] ATABD0[488 508 528 548] ATABD1[488 508 528 548] ATABD2[488 508 528 548] WORKMODE[1]"#;
        let _: EStats = de::from_str(s).unwrap();
    }

    #[test]
    fn test_str3() {
        let s = r#"Ver[1166Pro-75-21030201_4ec6bb0_09b1765] DNA[02010000c2c6f362] MEMFREE[1207600.0] NETFAIL[0 0 0 0 0 0 0 0] SYSTEMSTATU[Work: In Work, Hash Board: 2 ] Elapsed[2458] BOOTBY[0x05.00000000] LW[1145096] MH[8 3 0] HW[11] DH[33.190%] Temp[31] TMax[116] TAvg[58] Fan1[2202] Fan2[2221] Fan3[6911] Fan4[6872] FanR[25%] Vo[327] PS[0 1214 1310 -91 2161 1308] PLL0[4762 76 93 8989] PLL1[13565 229 90 36] PLL2[0 0 0 0] GHSspd[45779.92] DHspd[11.959%] GHSmm[52107.44] GHSavg[45541.27] WU[636204.21] Freq[311.95] Led[0] MGHS[25909.62 19631.65 0.00] MTmax[116 62 -273] MTavg[63 54 0] TA[240] Core[A3201] PING[39] POWS[0] HASHS[0 0 1] POOLS[0] SoftOFF[0] ECHU[0 0 131073] ECMM[4] SF0[448 468 488 508] SF1[448 468 488 508] SF2[448 468 488 508] PVT_T0[ 65  73  70  68  71  70  69  69  69  69  71  69  70  71  69 116  70  64  66  66  77  71  64  68  64  66  67  68  65  68  61  67  67  63  66  62  63  62  64  64  62  64  59  62  61  62  60  59  58  58  61  62  61  60  54  59  59  60  55  57  55  55  56  56  54  54  59  54  56  57  59  57  57  57  57  63  59  60  58  59  59  60  57  61  59  59  58  58  58  57  58  60  58  59  59  59  63  62  65  67  64  67  64  64  64  67  63  64  66  66  63  63  64  62  66  65  65  62  70  69] PVT_T1[ 54  61  60  56  55  54  54  57  56  54  58  51  55  58  56  57  60  57  54  57  58  59  59  57  55  57  58  57  60  55  52  58  62  59  58  54  54  57  59  58  56  56  59  57  59  55  58  55  59  54  54  53  55  54  54  54  54  54  53  56  53  48  50  51  54  54  50  47  53  54  52  51  52  49  51  52  53  54  54  54  51  51  52  54  52  55  54  51  51  53  54  53  52  52  53  53  56  52  53  51  53  56  53  54  54  54  56  54  54  55  54  54  56  57  56  56  53  57  59  60] PVT_T2[-273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273 -273] PVT_V0[299 302 306 306 305 303 307 301 302 309 312 310 305 302 304 342 303 303 299 301 299 296 295 295 300 298 305 301 306 307 306 306 305 303 304 306 298 295 296 298 298 297 300 302 301 306 305 304 303 301 301 308 306 307 309 310 311 306 306 309 314 305 304 304 306 310 314 311 314 308 307 308 306 310 306 310 307 312 306 313 310 315 313 316 300 301 301 305 305 303 303 301 304 302 305 306 308 313 309 318 313 314 307 309 305 300 294 297 293 295 295 297 299 298 296 295 295 294 297 298] PVT_V1[305 312 310 309 307 307 309 310 309 310 309 311 308 309 311 315 316 311 309 310 311 310 309 309 306 305 305 301 304 305 301 302 306 302 302 300 302 306 303 304 303 304 309 308 306 306 313 312 309 312 315 305 305 307 302 302 305 301 304 312 309 306 305 303 305 305 307 308 309 310 311 311 307 308 310 306 307 305 314 312 311 310 309 309 306 306 309 307 310 307 310 310 311 311 311 314 303 307 306 307 307 311 305 310 307 305 306 306 305 304 307 304 305 306 303 302 302 307 308 313] PVT_V2[0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0] MW[817109 817008 0] MW0[109 140 146 137 118 120 101 124 116 124 95 113 106 95 111 117 132 131 125 123 81 114 134 144 114 117 121 128 129 127 110 125 137 118 129 116 102 131 109 126 139 111 120 127 124 104 129 121 117 145 113 115 120 126 153 124 113 132 122 123 115 126 124 128 122 110 112 125 144 112 116 121 131 122 134 104 144 125 119 102 114 136 116 103 108 147 118 125 119 125 122 121 112 120 112 125 98 122 122 138 111 117 107 108 109 123 129 122 113 127 121 135 134 111 105 118 132 118 119 116] MW1[89 110 118 70 84 116 90 113 110 86 93 110 102 100 101 105 99 101 94 97 89 94 102 72 106 83 102 87 81 78 89 87 99 75 60 93 91 95 75 79 102 80 122 89 99 99 95 104 86 108 109 76 74 75 82 102 70 60 101 92 81 65 72 59 61 66 80 81 111 97 96 108 79 78 105 78 88 81 111 91 101 87 96 125 120 96 78 97 89 106 87 111 87 110 103 99 90 94 82 79 93 81 92 88 111 86 89 110 78 86 101 81 88 82 101 84 61 89 97 103] MW2[0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0] ASICCRC0[0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0] ASICCRC1[0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0] ASICCRC2[0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0] CRC[0 0 0] POW_I2C[OK] FACOPTS0[] FACOPTS1[] ATAOPTS0[--avalon10-freq 448:468:488:508 --avalon10-voltage-level 52 ] ATAOPTS1[--avalon10-freq 448:468:488:508 --avalon10-voltage-level 52 ] ADJ[1] COP[0 0 0] MPO[3200] MVL[87] ATABD0[448 468 488 508] ATABD1[448 468 488 508] ATABD2[448 468 488 508] WORKMODE[1]"#;
        let _: EStats = de::from_str(s).unwrap();
    }
}
